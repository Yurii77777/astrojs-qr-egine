import type { ECLevel, Mode, SizeClass } from './types';

export interface ECBlockGroup {
  count: number;
  dataBytes: number;
  ecBytes: number;
}

export interface ECEntry {
  totalDataBytes: number;
  group1: ECBlockGroup;
  group2?: ECBlockGroup;
}

type ECTable = Record<number, Record<ECLevel, ECEntry>>;

function e(
  totalDataBytes: number,
  ecBytes: number,
  g1Count: number,
  g1Data: number,
  g2Count?: number,
  g2Data?: number,
): ECEntry {
  const entry: ECEntry = {
    totalDataBytes,
    group1: { count: g1Count, dataBytes: g1Data, ecBytes },
  };
  if (g2Count !== undefined && g2Data !== undefined) {
    entry.group2 = { count: g2Count, dataBytes: g2Data, ecBytes };
  }
  return entry;
}

// prettier-ignore
export const EC_TABLE: ECTable = {
  1: {
    L: e(19,  7, 1, 19),
    M: e(16, 10, 1, 16),
    Q: e(13, 13, 1, 13),
    H: e( 9, 17, 1,  9),
  },
  2: {
    L: e(34, 10, 1, 34),
    M: e(28, 16, 1, 28),
    Q: e(22, 22, 1, 22),
    H: e(16, 28, 1, 16),
  },
  3: {
    L: e(55, 15, 1, 55),
    M: e(44, 26, 1, 44),
    Q: e(34, 18, 2, 17),
    H: e(26, 22, 2, 13),
  },
  4: {
    L: e(80, 20, 1, 80),
    M: e(64, 18, 2, 32),
    Q: e(48, 26, 2, 24),
    H: e(36, 16, 4,  9),
  },
  5: {
    L: e(108, 26, 1, 108),
    M: e( 86, 24, 2,  43),
    Q: e( 62, 18, 2, 15, 2, 16),
    H: e( 46, 22, 2, 11, 2, 12),
  },
  6: {
    L: e(136, 18, 2, 68),
    M: e(108, 16, 4, 27),
    Q: e( 76, 24, 4, 19),
    H: e( 60, 28, 4, 15),
  },
  7: {
    L: e(156, 20, 2, 78),
    M: e(124, 18, 4, 31),
    Q: e( 88, 18, 2, 14, 4, 15),
    H: e( 66, 26, 4, 13, 1, 14),
  },
  8: {
    L: e(194, 24, 2, 97),
    M: e(154, 22, 2, 38, 2, 39),
    Q: e(110, 22, 4, 18, 2, 19),
    H: e( 86, 26, 4, 14, 2, 15),
  },
  9: {
    L: e(232, 30, 2, 116),
    M: e(182, 22, 3, 36, 2, 37),
    Q: e(132, 20, 4, 16, 4, 17),
    H: e(100, 24, 4, 12, 4, 13),
  },
  10: {
    L: e(274, 18, 2, 68, 2, 69),
    M: e(216, 26, 4, 43, 1, 44),
    Q: e(154, 24, 6, 19, 2, 20),
    H: e(122, 28, 6, 15, 2, 16),
  },
  11: {
    L: e(324, 20, 4, 81),
    M: e(254, 30, 1, 50, 4, 51),
    Q: e(180, 28, 4, 22, 4, 23),
    H: e(140, 24, 3, 12, 8, 13),
  },
  12: {
    L: e(370, 24, 2, 92, 2, 93),
    M: e(290, 22, 6, 36, 2, 37),
    Q: e(206, 26, 4, 20, 6, 21),
    H: e(158, 28, 7, 14, 4, 15),
  },
  13: {
    L: e(428, 26, 4, 107),
    M: e(334, 22, 8, 37, 1, 38),
    Q: e(244, 24, 8, 20, 4, 21),
    H: e(180, 22, 12, 11, 4, 12),
  },
  14: {
    L: e(461, 30, 3, 115, 1, 116),
    M: e(365, 24, 4, 40, 5, 41),
    Q: e(261, 20, 11, 16, 5, 17),
    H: e(197, 24, 11, 12, 5, 13),
  },
  15: {
    L: e(523, 22, 5, 87, 1, 88),
    M: e(415, 24, 5, 41, 5, 42),
    Q: e(295, 30, 5, 24, 7, 25),
    H: e(223, 24, 11, 12, 7, 13),
  },
  16: {
    L: e(589, 24, 5, 98, 1, 99),
    M: e(453, 28, 7, 45, 3, 46),
    Q: e(325, 24, 15, 19, 2, 20),
    H: e(253, 30, 3, 15, 13, 16),
  },
  17: {
    L: e(647, 28, 1, 107, 5, 108),
    M: e(507, 28, 10, 46, 1, 47),
    Q: e(367, 28, 1, 22, 15, 23),
    H: e(283, 28, 2, 14, 17, 15),
  },
  18: {
    L: e(721, 30, 5, 120, 1, 121),
    M: e(563, 26, 9, 43, 4, 44),
    Q: e(397, 28, 17, 22, 1, 23),
    H: e(313, 28, 2, 14, 19, 15),
  },
  19: {
    L: e(795, 28, 3, 113, 4, 114),
    M: e(627, 26, 3, 44, 11, 45),
    Q: e(445, 26, 17, 21, 4, 22),
    H: e(341, 26, 9, 13, 16, 14),
  },
  20: {
    L: e(861, 28, 3, 107, 5, 108),
    M: e(669, 26, 3, 41, 13, 42),
    Q: e(485, 28, 15, 24, 5, 25),
    H: e(385, 28, 15, 15, 10, 16),
  },
  21: {
    L: e(932, 28, 4, 116, 4, 117),
    M: e(714, 26, 17, 42),
    Q: e(512, 30, 17, 22, 6, 23),
    H: e(406, 28, 19, 16, 6, 17),
  },
  22: {
    L: e(1006, 28, 2, 111, 7, 112),
    M: e(  782, 28, 17, 46),
    Q: e(  568, 24, 7, 24, 16, 25),
    H: e(  442, 30, 34, 13),
  },
  23: {
    L: e(1094, 30, 4, 121, 5, 122),
    M: e( 860, 28, 4, 47, 14, 48),
    Q: e( 614, 30, 11, 24, 14, 25),
    H: e( 464, 30, 16, 15, 14, 16),
  },
  24: {
    L: e(1174, 30, 6, 117, 4, 118),
    M: e( 914, 28, 6, 45, 14, 46),
    Q: e( 664, 30, 11, 24, 16, 25),
    H: e( 514, 30, 30, 16, 2, 17),
  },
  25: {
    L: e(1276, 26, 8, 106, 4, 107),
    M: e(1000, 28, 8, 47, 13, 48),
    Q: e( 718, 30, 7, 24, 22, 25),
    H: e( 538, 30, 22, 15, 13, 16),
  },
  26: {
    L: e(1370, 28, 10, 114, 2, 115),
    M: e(1062, 28, 19, 46, 4, 47),
    Q: e( 754, 28, 28, 22, 6, 23),
    H: e( 596, 30, 33, 16, 4, 17),
  },
  27: {
    L: e(1468, 30, 8, 122, 4, 123),
    M: e(1128, 28, 22, 45, 3, 46),
    Q: e( 808, 30, 8, 23, 26, 24),
    H: e( 628, 30, 12, 15, 28, 16),
  },
  28: {
    L: e(1531, 30, 3, 117, 10, 118),
    M: e(1193, 28, 3, 45, 23, 46),
    Q: e( 871, 30, 4, 24, 31, 25),
    H: e( 661, 30, 11, 15, 31, 16),
  },
  29: {
    L: e(1631, 30, 7, 116, 7, 117),
    M: e(1267, 28, 21, 45, 7, 46),
    Q: e( 911, 30, 1, 23, 37, 24),
    H: e( 701, 30, 19, 15, 26, 16),
  },
  30: {
    L: e(1735, 30, 5, 115, 10, 116),
    M: e(1373, 28, 19, 47, 10, 48),
    Q: e( 985, 30, 15, 24, 25, 25),
    H: e( 745, 30, 23, 15, 25, 16),
  },
  31: {
    L: e(1843, 30, 13, 115, 3, 116),
    M: e(1455, 28, 2, 46, 29, 47),
    Q: e(1033, 30, 42, 24, 1, 25),
    H: e( 793, 30, 23, 15, 28, 16),
  },
  32: {
    L: e(1955, 30, 17, 115),
    M: e(1541, 28, 10, 46, 23, 47),
    Q: e(1115, 30, 10, 24, 35, 25),
    H: e( 845, 30, 19, 15, 35, 16),
  },
  33: {
    L: e(2071, 30, 17, 115, 1, 116),
    M: e(1631, 28, 14, 46, 21, 47),
    Q: e(1171, 30, 29, 24, 19, 25),
    H: e( 901, 30, 11, 15, 46, 16),
  },
  34: {
    L: e(2191, 30, 13, 115, 6, 116),
    M: e(1725, 28, 14, 46, 23, 47),
    Q: e(1231, 30, 44, 24, 7, 25),
    H: e( 961, 30, 59, 16, 1, 17),
  },
  35: {
    L: e(2306, 30, 12, 121, 7, 122),
    M: e(1812, 28, 12, 47, 26, 48),
    Q: e(1286, 30, 39, 24, 14, 25),
    H: e(  986, 30, 22, 15, 41, 16),
  },
  36: {
    L: e(2434, 30, 6, 121, 14, 122),
    M: e(1914, 28, 6, 47, 34, 48),
    Q: e(1354, 30, 46, 24, 10, 25),
    H: e(1054, 30, 2, 15, 64, 16),
  },
  37: {
    L: e(2566, 30, 17, 122, 4, 123),
    M: e(1992, 28, 29, 46, 14, 47),
    Q: e(1426, 30, 49, 24, 10, 25),
    H: e(1096, 30, 24, 15, 46, 16),
  },
  38: {
    L: e(2702, 30, 4, 122, 18, 123),
    M: e(2102, 28, 13, 46, 32, 47),
    Q: e(1502, 30, 48, 24, 14, 25),
    H: e(1142, 30, 42, 15, 32, 16),
  },
  39: {
    L: e(2812, 30, 20, 117, 4, 118),
    M: e(2216, 28, 40, 47, 7, 48),
    Q: e(1582, 30, 43, 24, 22, 25),
    H: e(1222, 30, 10, 15, 67, 16),
  },
  40: {
    L: e(2956, 30, 19, 118, 6, 119),
    M: e(2334, 28, 18, 47, 31, 48),
    Q: e(1666, 30, 34, 24, 34, 25),
    H: e(1276, 30, 20, 15, 61, 16),
  },
};

// prettier-ignore
export const ALIGNMENT_COORDS: Record<number, number[]> = {
  2:  [6, 18],
  3:  [6, 22],
  4:  [6, 26],
  5:  [6, 30],
  6:  [6, 34],
  7:  [6, 22, 38],
  8:  [6, 24, 42],
  9:  [6, 26, 46],
  10: [6, 28, 50],
  11: [6, 30, 54],
  12: [6, 32, 58],
  13: [6, 34, 62],
  14: [6, 26, 46, 66],
  15: [6, 26, 48, 70],
  16: [6, 26, 50, 74],
  17: [6, 30, 54, 78],
  18: [6, 30, 56, 82],
  19: [6, 30, 58, 86],
  20: [6, 34, 62, 90],
  21: [6, 28, 50, 72, 94],
  22: [6, 26, 50, 74, 98],
  23: [6, 30, 54, 78, 102],
  24: [6, 28, 54, 80, 106],
  25: [6, 32, 58, 84, 110],
  26: [6, 30, 58, 86, 114],
  27: [6, 34, 62, 90, 118],
  28: [6, 26, 50, 74, 98, 122],
  29: [6, 30, 54, 78, 102, 126],
  30: [6, 26, 52, 78, 104, 130],
  31: [6, 30, 56, 82, 108, 134],
  32: [6, 34, 60, 86, 112, 138],
  33: [6, 30, 58, 86, 114, 142],
  34: [6, 34, 62, 90, 118, 146],
  35: [6, 30, 54, 78, 102, 126, 150],
  36: [6, 24, 50, 76, 102, 128, 154],
  37: [6, 28, 54, 80, 106, 132, 158],
  38: [6, 32, 58, 84, 110, 136, 162],
  39: [6, 26, 54, 82, 110, 138, 166],
  40: [6, 30, 58, 86, 114, 142, 170],
};

// prettier-ignore
export const REMAINDER_BITS: Record<number, number> = {
  2: 7, 3: 7, 4: 7, 5: 7, 6: 7,
  14: 3, 15: 3, 16: 3, 17: 3, 18: 3, 19: 3, 20: 3,
  21: 4, 22: 4, 23: 4, 24: 4, 25: 4, 26: 4, 27: 4,
  28: 3, 29: 3, 30: 3, 31: 3, 32: 3, 33: 3, 34: 3,
};

export function getRemainderBits(version: number): number {
  return REMAINDER_BITS[version] ?? 0;
}

export function getCharCountBits(mode: Mode, version: number): number {
  if (version <= 9) {
    return { Numeric: 10, Alphanumeric: 9, Byte: 8 }[mode];
  } else if (version <= 26) {
    return { Numeric: 12, Alphanumeric: 11, Byte: 16 }[mode];
  } else {
    return { Numeric: 14, Alphanumeric: 13, Byte: 16 }[mode];
  }
}

export const SIZE_CLASS_RANGE: Record<SizeClass, [number, number]> = {
  S: [1, 5],
  M: [6, 15],
  L: [16, 25],
};

export const ALPHANUM_CHARSET = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ $%*+-./:';

export const ALPHANUM_INDEX: Record<string, number> = {};
for (let i = 0; i < ALPHANUM_CHARSET.length; i++) {
  ALPHANUM_INDEX[ALPHANUM_CHARSET[i]] = i;
}

export const MODE_INDICATOR: Record<Mode, number> = {
  Numeric: 0b0001,
  Alphanumeric: 0b0010,
  Byte: 0b0100,
};
